# Инструкция по тестированию Real-time обновлений

## Подготовка

1. Запустите приложение: `npm run dev`
2. Откройте два окна браузера (или используйте обычный режим + инкогнито)
3. Войдите в разные аккаунты:
   - **Браузер 1**: Пользователь-капитан команды
   - **Браузер 2**: Обычный игрок без команды

## Тест 1: Приглашение игрока в команду

### Шаги:
1. **Браузер 2** (игрок):
   - Откройте TopBar → нажмите на аватар
   - Нажмите "Уведомления" — должно быть пусто
   - Оставьте диалог открытым

2. **Браузер 1** (капитан):
   - Перейдите в раздел "Команды"
   - Откройте свою команду → "Управление командой"
   - Во вкладке "Заявки и приглашения" нажмите "Пригласить игрока"
   - Найдите и пригласите игрока из Браузера 2

### Ожидаемый результат:
✅ **Браузер 2** — приглашение появляется в диалоге уведомлений **мгновенно** без обновления страницы  
✅ **Браузер 2** — badge с количеством уведомлений (красный кружок) на аватаре увеличивается  
✅ **Браузер 1** — приглашение появляется в списке "Отправленные приглашения"

## Тест 2: Заявка игрока в команду

### Шаги:
1. **Браузер 1** (капитан):
   - Перейдите в "Управление командой" → вкладка "Заявки и приглашения"
   - Оставьте страницу открытой

2. **Браузер 2** (игрок):
   - Перейдите в "Команды"
   - Найдите команду из Браузера 1
   - Нажмите "Подать заявку"

### Ожидаемый результат:
✅ **Браузер 1** — новая заявка появляется в списке **мгновенно** без обновления  
✅ **Sidebar** в Браузере 1 — badge с количеством заявок увеличивается на вкладке "Команды"  
✅ **Браузер 2** — заявка появляется в уведомлениях со статусом "На рассмотрении"

## Тест 3: Принятие/Отклонение заявки

### Шаги:
1. **Браузер 2** (игрок):
   - Откройте "Уведомления" → вкладка "Мои заявки"
   - Оставьте диалог открытым

2. **Браузер 1** (капитан):
   - В "Управление командой" → "Заявки и приглашения"
   - Нажмите "Принять" или "Отклонить" на заявке игрока

### Ожидаемый результат:
✅ **Браузер 2** — статус заявки меняется **мгновенно** (с "На рассмотрении" на "Принята"/"Отклонена")  
✅ **Браузер 2** — badge уведомлений увеличивается (теперь показывает измененный статус)  
✅ **Браузер 1** — заявка исчезает из списка pending

## Тест 4: Принятие/Отклонение приглашения

### Шаги:
1. **Браузер 1** (капитан):
   - В "Управление командой" → "Отправленные приглашения"
   - Оставьте страницу открытой

2. **Браузер 2** (игрок):
   - Откройте "Уведомления" → вкладка "Приглашения в команды"
   - Нажмите "Принять" или "Отклонить"

### Ожидаемый результат:
✅ **Браузер 1** — приглашение исчезает из списка **мгновенно**  
✅ **Браузер 2** — приглашение исчезает из уведомлений  
✅ **Браузер 2** — если принято: пользователь добавлен в команду (проверьте в профиле/странице команды)

## Тест 5: Множественные каналы (для капитанов нескольких команд)

Если у вас есть пользователь, который является капитаном/тренером нескольких команд:

### Шаги:
1. Откройте страницу с таким пользователем
2. Отправьте заявки в разные команды из других аккаунтов

### Ожидаемый результат:
✅ Все заявки появляются мгновенно для соответствующих команд  
✅ Счетчик в Sidebar суммирует заявки по всем командам  
✅ Нет дублирующихся подписок или ошибок в консоли

## Проверка на ошибки

### Открыть DevTools → Console:
- ❌ Не должно быть ошибок от Supabase Realtime
- ❌ Не должно быть ошибок RLS (Row Level Security)
- ❌ Не должно быть утечек памяти (channels должны очищаться)

### Проверка Network → WS (WebSocket):
- ✅ Должны быть активные WebSocket соединения
- ✅ При получении события видны сообщения в формате JSON
- ✅ При закрытии страницы соединения должны закрываться

## Дополнительные проверки

### Проверка производительности:
1. Откройте React DevTools → Profiler
2. Выполните действие (отправка приглашения/заявки)
3. Убедитесь, что нет лишних ре-рендеров компонентов

### Проверка на утечку каналов:
1. Откройте компонент с real-time подпиской
2. Закройте/откройте несколько раз
3. В консоли не должно быть накопления каналов
4. Проверьте через `console.log` внутри хуков (если нужно)

## Отладка

Если что-то не работает:

1. **Проверьте Supabase Dashboard**:
   - Настройки проекта → API → Realtime включен?
   - Database → Replication → Включены ли таблицы для Realtime?

2. **Проверьте RLS политики**:
   ```sql
   SELECT * FROM pg_policies 
   WHERE tablename IN ('notifications', 'team_invitations', 'team_applications');
   ```

3. **Проверьте консоль браузера**:
   - Ошибки подключения к WebSocket?
   - Ошибки RLS при SELECT?
   - Ошибки при создании каналов?

4. **Проверьте фильтры**:
   - userId передается корректно?
   - managedTeamIds не пустой для капитанов?
   - Фильтры соответствуют RLS политикам?

## Успешное выполнение тестов

Все тесты пройдены успешно, если:
- ✅ Все обновления происходят мгновенно
- ✅ Нет необходимости вручную обновлять страницу
- ✅ Счетчики badge обновляются корректно
- ✅ Нет ошибок в консоли браузера
- ✅ WebSocket соединения стабильны
- ✅ При закрытии страницы соединения корректно закрываются


